#!/usr/bin/env bash
set -euo pipefail

MUSIC_DIR="$HOME/Music"
COVER=/tmp/cover.png # image will be saved.
LAST_SONG_FILE="/tmp/last_song.txt"
BKP_COVER=$(<"$HOME/.config/dots/rices/.wall")
THUMBNAIL_SIZE=300x300

_mpc() {
  local mpd_host mpd_port
  case $(<"$HOME/.config/dots/.mpd_status") in
  "remote")
    mpd_host="$(<"$HOME/.config/dots/.mpd_host")"
    mpd_port="6600"
    ;;
  # "vpn")
  #   mpd_host="127.0.0.1"
  #   mpd_port="6600"
  #   ;;
  "local")
    mpd_host="127.0.0.1"
    mpd_port="6600"
    ;;
  *)
    mpd_host="localhost"
    mpd_port="6600"
    ;;
  esac
  mpc --port "${mpd_port:-6600}" \
    --host "${mpd_host:-127.0.0.1}" "$@"
}

# Extract cover art from music file
extract_cover() {
  local music_file
  music_file="$MUSIC_DIR/$("$0" --file)"
  [[ -f $music_file ]] && {
    if ffmpeg -i "$music_file" "$COVER" -y &>/dev/null; then
      echo "$COVER" && return 0
    fi
  }
  [[ -f $BKP_COVER ]] && {
    magick "$BKP_COVER" -resize "${THUMBNAIL_SIZE}^" -gravity center -extent "$THUMBNAIL_SIZE" "$COVER" || {
      echo "Warning: Failed to process $BKP_COVER" >&2
    }
    echo "$COVER" && return 0
  }
}

case $1 in
# manipulation
--next) _mpc -q next ;;
--previous) _mpc -q prev ;;
--toggle) _mpc -q toggle ;;
--stop) _mpc -q stop ;;
--single-on) _mpc single on ;;
--single-off) _mpc single off ;;
--seek) _mpc seek "${2:-0:00}" ;;
# --seeks) _mpc seek "${2:-0}" ;;
# info checks
--file) file=$(_mpc current -f %file%) && echo "${file:-No File}" ;;
--title) title=$(_mpc current -f %title%) && echo "${title:-Play Something}" ;;
--artist) artist=$(_mpc current -f %artist%) && echo "${artist:-No Artist}" ;;
--song) song=$(_mpc current -f "%artist% - %title%") && echo "${song:-No Song}" ;;
--status) status=$(_mpc status | awk 'NR==2 { gsub(/[\[\]]/, "", $1); print $1 }' | tr p P) && echo "${status:-Stopped}" ;;
--notify)
  COVER=$("$0" --cover) && TITLE=$("$0" --title) && ARTIST=$("$0" --artist)
  notify-send -r 1001 -i "$COVER" "Now Playing" "${ARTIST}\n${TITLE}"
  ;;
--cover)
  current_song=$("$0" --song) && last_song=""
  [[ -f $LAST_SONG_FILE ]] && last_song=$(<"$LAST_SONG_FILE")
  [[ "$current_song" != "$last_song" ]] && extract_cover && echo "$current_song" >"$LAST_SONG_FILE"
  ;;
# time checks
--position) position=$(_mpc status %currenttime%) && echo "${position:-0:00}" ;;
--positions) positions=$(_mpc status %currenttime% | awk -F: '{print ($1 * 60) + $2}') && echo "${positions:-0}" ;;
--length) length=$(_mpc status %totaltime%) && echo "${length:-0:00}" ;;
--lengths) lengths=$(_mpc status %totaltime% | awk -F: '{print ($1 * 60) + $2}') && echo "${lengths:-0}" ;;
# states checks
--shuffle) shuffle=$(_mpc status | sed -n '3s/.*random: \([^ ]*\).*/\1/p' | sed 's/.*/\u&/') && echo "${shuffle:-Off}" ;;
--loop) loop=$(_mpc status | sed -n '3s/.*repeat: \([^ ]*\).*/\1/p' | sed 's/.*/\u&/') && echo "${loop:-Off}" ;;
--single) single=$(_mpc status | sed -n '3s/.*single: \([^ ]*\).*/\1/p' | sed 's/.*/\u&/') && echo "${single:-Off}" ;;
*)
  echo "Unknown option: $1" >&2
  echo "Use --help for usage information" >&2
  exit 1
  ;;
esac 2>/dev/null
