#!/usr/bin/env bash
set -euo pipefail

# CONSTS
EXECUTER_DIR="$HOME/.local/bin/executer"
LOG_FILE="$HOME/.cache/wal/wall_color.log"
WALL=$HOME/.config/dots/rices/.wall

# Flags
WAIT=""

while (($# > 0)); do
  case $1 in
  -w | --wait)
    WAIT=true
    shift
    ;;
  *)
    echo "Unknown option: $1"
    ;;
  esac
done

mkdir -p "${LOG_FILE%/*}"
echo "=== Wal Color Apply Start: $(date '+%F %T') ===" >"$LOG_FILE"

log() {
  echo "[$(date '+%T')] INFO: $*" | tee -a "$LOG_FILE" >/dev/null
}

error() {
  echo "[$(date '+%T')] ERROR: $*" | tee -a "$LOG_FILE" >&2
}

color() {
  local theme="$1"
  local pid_file="/tmp/wal_${theme}.pid"

  log "Starting $theme (background)"

  (
    if sh -c "$EXECUTER_DIR/.wal_${theme}.sh" >>"$LOG_FILE" 2>&1; then
      log "Finished $theme (success)"
    else
      error "Failed $theme (exit code: $?)"
    fi
    rm -f "$pid_file"
  ) &

  local pid=$!
  echo "$pid" >"$pid_file"
  log "$theme launched with PID: $pid"
}

[[ -f $WALL ]] || {
  error "Wallpaper file not found: $WALL"
  exit 1
}

log "Running wal..."

wal -sti "$(<"$WALL")" || {
  error "wal command failed"
  exit 1
}

# Source colors with fallback
if [[ -f "$HOME/.cache/wal/colors.sh" ]]; then
  # shellcheck disable=SC1091
  source "$HOME/.cache/wal/colors.sh"
  log "Loaded colors from wal"
else
  error "Colors file not found after wal execution"
  exit 1
fi

themes=(
  btop
  cursor
  dunst
  kitty
  nvchad
  obsidian
  p10k
  plasma
  qbit
  rmpc
  sddm
  telegram
  tmux
  waybar
  yazi
)

for theme in "${themes[@]}"; do
  color "$theme"
done

log "All themes launched in background"

[[ -n $WAIT ]] && {
  log "Waiting for all themes..."
  pids=(/tmp/wal_*.pid)

  while [[ -e "${pids[0]}" ]]; do
    sleep 0.5
    pids=(/tmp/wal_*.pid)
  done

  dunstify "Wall Color" "All Themes Completed"
}
