#!/usr/bin/env bash
set -euo pipefail

# CONSTANTS
CACHE_BASE="${HOME}/.cache/wallpapers"
CONFIG_DIR="${HOME}/.config/dots"
RICES_DIR="${CONFIG_DIR}/rices"
THUMBNAIL_SIZE="500x500"
REQUIRED_APPS=(
  xdpyinfo
  magick
  md5sum
  rofi
)

# Check for required apps
for app in "${REQUIRED_APPS[@]}"; do
  command -v "$app" >/dev/null 2>&1 || {
    dunstify -u critical "Missing package" "Please install '$app' to continue"
    exit 1
  }
done

# VARS
current_rice=$(<"${CONFIG_DIR}/.rice")
current_wallpaper_path=$(<"${RICES_DIR}/.wall")
current_wallpaper="${current_wallpaper_path##*/}"
wall_dir="${RICES_DIR}/${current_rice}/walls"
cache_dir="${CACHE_BASE}/${current_rice}"

# Validate
[[ -d $wall_dir ]] || {
  dunstify -u critical "Error" "Wallpaper directory not found: $wall_dir"
  exit 1
}
[[ -d $cache_dir ]] || mkdir -p "$cache_dir"

# Adapt to screen resolution.
monitor_res=$(($(xdpyinfo | awk '/dimensions/{print $2}' | cut -d 'x' -f1) * 14 / $(xdpyinfo | awk '/resolution/{print $2}' | cut -d 'x' -f1)))
rofi_override="element-icon{size:${monitor_res}px;}"
rofi_command="rofi -dmenu -theme $HOME/.config/rofi/WallSelect.rasi -theme-str $rofi_override"

wallpapers=()
# Convert images in directory and save to cache dir
for image in "$wall_dir"/*; do
  [[ $image =~ \.(jpg|png|webp)$ ]] || continue

  archive=${image##*/}
  cache_file="${cache_dir}/${archive}"
  md5_file="${cache_dir}/.${archive}.md5"

  # Generate thumbnail if needed
  if [[ ! -f $cache_file ]] || [[ ! -f $md5_file ]] ||
    [[ "$(md5sum "$image" | cut -d' ' -f1)" != "$(<"$md5_file")" ]]; then

    printf "Generating thumbnail: %s\n" "$archive" >&2
    magick "$image" -resize "${THUMBNAIL_SIZE}^" -gravity center -extent "$THUMBNAIL_SIZE" "$cache_file" || {
      printf "Warning: Failed to process %s\n" "$archive" >&2
      continue
    }
    md5sum "$image" | cut -d' ' -f1 >"$md5_file"
  fi

  wallpapers+=("$archive")
done

# index of current wallpaper
for i in "${!wallpapers[@]}"; do
  [[ "${wallpapers[$i]}" == "$current_wallpaper" ]] && selected_index=$i && break
done

# Launch rofi
wall_selection=$(for wall in "${wallpapers[@]}"; do
  # TODO: fix text bug
  printf '%s\0icon\x1f%s\n' "${wall}" "${cache_dir}/$wall"
done | $rofi_command -selected-row "${selected_index:-0}")

# Set wallpaper
[[ -n $wall_selection ]] && {
  echo "${wall_dir}/${wall_selection}" >"${RICES_DIR}/.wall"
  WallColor --wait
}
