#!/usr/bin/env bash
set -euo pipefail
export PATH="$HOME/.local/bin/executer:$HOME/.local/bin:$PATH"

# CONSTANTS
ROFI_THEME="$HOME/.config/rofi/WallSelect.rasi"
CACHE_BASE="$HOME/.cache/wallpapers"
CONFIG_DIR="$HOME/.config/dots"
RICES_DIR="$CONFIG_DIR/rices"
THUMBNAIL_SIZE="500x500"
REQUIRED_APPS=(
  xrandr
  md5sum
  dunst
  rofi
  vips
)

for app in "${REQUIRED_APPS[@]}"; do
  command -v "$app" >/dev/null 2>&1 || {
    dunstify -u critical "Missing package" "Please install '$app' to continue"
    exit 1
  }
done

# VARS
current_rice=$(<"$CONFIG_DIR/.rice")
current_wallpaper_path=$(<"$RICES_DIR/.wall")
current_wallpaper="${current_wallpaper_path##*/}"
wall_dir="$RICES_DIR/$current_rice/walls"
cache_dir="$CACHE_BASE/$current_rice"

# Validate
[[ -d $cache_dir ]] || mkdir -p "$cache_dir"
[[ -d $wall_dir ]] || {
  dunstify -u critical "Error" "Wallpaper directory not found: $wall_dir"
  exit 1
}
read -r _ _ res _ < <(xrandr -q | grep ' connected')
monitor_res=${res%%x*}
monitor_res=$((monitor_res * 14 / 96))

generate_thumbnail() {
  _thumbnail_cmd() {
    vipsthumbnail --size="${THUMBNAIL_SIZE}" \
      "$image" --crop=centre -o "$cache_file"
  }
  local image=$1
  local archive=${image##*/}
  local cache_file="${cache_dir}/${archive}"
  local md5_file="${cache_dir}/.${archive}.md5"
  [[ -f $cache_file && $cache_file -nt $image ]] && return 0
  local sum _
  read -r sum _ < <(md5sum "$image")
  { _thumbnail_cmd; } 2>/dev/null &&
    printf '%s\n' "$sum" >"$md5_file"
}

export -f generate_thumbnail
export cache_dir THUMBNAIL_SIZE

shopt -s nullglob
mapfile -t images < <(printf '%s\n' "$wall_dir"/*.{jpg,png,webp} | sort)
wallpapers=() && generate=() && idx=0

for i in "${!images[@]}"; do
  archive="${images[i]##*/}"
  cache_file="$cache_dir/$archive"
  wallpapers+=("$archive")
  [[ "$archive" == "$current_wallpaper" ]] && idx=$i
  [[ ! -f $cache_file ]] && generate+=("${images[i]}")
done

# Generate missing thumbnails in parallel
((${#generate[@]})) && {
  printf '%s\n' "${generate[@]}" |
    xargs -P "$(nproc)" -I {} bash -c \
      'generate_thumbnail "$@"' _ {}
}

# TODO: broken text
wall_selection=$(
  printf '%s\n' "${wallpapers[@]}" |
    awk -v c="$cache_dir" '{printf "%s\0icon\x1f%s/%s\n",$0,c,$0}' |
    rofi -dmenu -selected-row "$idx" -theme "$ROFI_THEME" \
      -theme-str "element-icon{size:${monitor_res}px;}"
)

[[ -n $wall_selection ]] && {
  echo "${wall_dir}/${wall_selection}" >"${RICES_DIR}/.wall"
  wal.sh --all --wait
}
