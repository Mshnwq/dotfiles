#!/usr/bin/env bash
set -euo pipefail

DOTDIR=$(<"$HOME/.config/dotdir")
DOTDIR="${DOTDIR/#\~/$HOME}"
BASE_DIR="$DOTDIR/local/bin/executer"
ROFI_DIR="$HOME/.config/rofi"
EXECR_THEME="$ROFI_DIR/Executer.rasi"
INPUT_THEME="$ROFI_DIR/Input.rasi"

# Get script case statement options
_opts() {
  grep -Po '^\s*--[a-z-]+(?:\s*\|\s*--[a-z-]+)*\)' \
    "$1" | sed 's# | #\n#g' | sed -E 's|^--([a-z-]+)\)?|\1|'
}

scripts="$(find "$BASE_DIR" -type f -executable -not -name ".*.sh" -printf "%f\n")"
mapfile -t locals < <(_opts "$0")
selected=$(printf '%s\n' "${scripts//.sh/}" "${locals[@]}" | sort | rofi -dmenu -theme "$EXECR_THEME")
[[ -n $selected ]] || exit 0

# if selected in here case
_alacritty() { alacritty --class FloaTerm,"$1" --title="$1" "${@:2}"; }
case "--$selected" in
--nvtop | --gpg-tui)
  _alacritty TopTerm -o 'font.size=12' -e "$selected"
  ;;&
--nvidia)
  _alacritty TopTerm -o 'font.size=14' -e sh -c "nvidia-smi -l"
  ;;&
*) [[ $selected =~ ^($(printf '%s|' "${locals[@]}"))$ ]] && exit 0 ;;
esac

# get script options
script="${BASE_DIR}/${selected}.sh"
mapfile -t opts < <(_opts "$script")

# Has no opts run it
[[ -z ${opts[*]} ]] && {
  "$script"
  exit 0
}

_fzf() {
  # shellcheck disable=SC2016
  SCRIPT="$script" PROMPT="${1:-Opt}" \
    TMP="$tmpfile" OPTS="$tmpfile.opts" \
    _alacritty ExecTerm -e sh -c '
      source "$HOME/.cache/wal/custom-fzf.sh"
      cat "$OPTS" | fzf --prompt="$PROMPT: " \
        --preview="highlight -O ansi $SCRIPT" \
        --preview-window=right:84%:wrap > "$TMP"
    '
  cat "$tmpfile"
}

declare -A actions=(
  ["daemons"]="start|status|stop"
  ["procs"]="kill|start|status"
)
tmpfile=$(mktemp)
trap 'rm -f "$tmpfile" "$tmpfile.opts"' EXIT

if [[ $selected == "wal" ]]; then
  read -ra themes < <("$script" --get)
  printf "%s\n" "${themes[@]}" >"$tmpfile.opts"
  option="theme"
  action=$(_fzf "Theme")
  [[ -n $action ]] || exit 1
else
  printf "%s\n" "${opts[@]}" >"$tmpfile.opts"
  option=$(_fzf "Option")
  [[ -n $option ]] || exit 1
  [[ $selected =~ ^($(printf '%s|' "${!actions[@]}"))$ ]] && {
    IFS='|' read -ra action_opts <<<"${actions[$selected]}"
    printf "%s\n" "${action_opts[@]}" >"$tmpfile.opts"
    action=$(_fzf "$option")
    [[ -n $action ]] || exit 1
  }
fi

# Execute the script
if grep -q "#INPUT_REQUIRED" "$script"; then
  "$script" "$(rofi -dmenu -theme "$INPUT_THEME" -p "Enter input for $selected: ")"
else
  "$script" "--$option" "${action:-}"
fi
