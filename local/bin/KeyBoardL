#!/usr/bin/env bash
set -euo pipefail

# Get main keyboard info
keyboard=$(hyprctl devices -j | jq -c '.keyboards[] | select(.main == true)')

# Exit if no main keyboard found
[[ -n $keyboard ]] || {
  echo "Error: No main keyboard found"
  exit 1
}

# Extract details
IFS=$'\t' read -r layouts_csv keyboard_name active_keymap caps_state num_state < <(
  jq -r '[.layout, .name, .active_keymap, .capsLock, .numLock] | @tsv' <<<"$keyboard"
)
IFS=',' read -ra layout_list <<<"$layouts_csv"

# Load layout mappings from config file
LAYOUT_CONFIG="$HOME/.config/keyboard_layouts.conf"
[[ -f $LAYOUT_CONFIG ]] || {
  echo "Creating example config file..."
  echo "US English=us" >"$LAYOUT_CONFIG"
}

declare -A layout
while IFS='=' read -r label code; do
  [[ -z $label || $label =~ ^[[:space:]]*# ]] && continue
  label=$(echo "$label" | xargs)
  code=$(echo "$code" | xargs)
  [[ -n $label && -n $code ]] && layout["$label"]="$code"
done <"$LAYOUT_CONFIG"

# Check if any layouts were loaded
((${#layout[@]} == 0)) && {
  echo "Error: No layouts defined in $LAYOUT_CONFIG"
  exit 1
}

rofi_menu() {
  local message="Current Layout: $active_keymap"$'\n\n'
  message+="Caps Lock: $caps_state"$'\n'
  message+="Num Lock: $num_state"
  printf '%s\n' "${!layout[@]}" | rofi \
    -dmenu \
    -markup-rows \
    -mesg "$message" \
    -p "Keyboard Layout" \
    -theme "${HOME}/.config/rofi/SelectorKeyboard.rasi"
}

# Layout switcher
selected=$(rofi_menu)
[[ -n $selected && -n ${layout[$selected]} ]] || {
  echo "Warning: Layout '$selected' not found in available layouts"
  exit 1
}

for ((i = 0; i < ${#layout[@]}; i++)); do
  [[ "${layout_list[$i]}" == "${layout[$selected]}" ]] && {
    hyprctl switchxkblayout "$keyboard_name" "$i"
    exit 0
  }
done
