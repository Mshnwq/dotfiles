#!/usr/bin/env bash

set -euo pipefail

# Get main keyboard info in one pass
keyboard=$(hyprctl devices -j | jq -c '.keyboards[] | select(.main == true)')

# Exit if no main keyboard found
if [[ -z "$keyboard" ]]; then
  echo "Error: No main keyboard found" >&2
  exit 1
fi

# Extract details using jq once
read -r keyboard_name active_keymap caps_state num_state layouts_csv < <(
  echo "$keyboard" | jq -r '[.name, .active_keymap, .capsLock, .numLock, .layout] | @tsv'
)

# Convert CSV layouts to array
IFS=',' read -ra layout_list <<<"$layouts_csv"

# Layout labels and mapping
declare -A LAYOUTS=(
  ["US English"]="us"
  ["AR العربية"]="ara"
  ["RU Россия"]="ru"
)

# Show layout chooser with rofi
show_rofi_menu() {
  local message="Current Layout: $active_keymap"$'\n\n'
  message+="Caps Lock: $caps_state"$'\n'
  message+="Num Lock: $num_state"

  printf '%s\n' "${!LAYOUTS[@]}" | rofi \
    -dmenu \
    -p "Keyboard Layout" \
    -mesg "$message" \
    -markup-rows \
    -theme "${HOME}/.config/rofi/SelectorKeyboard.rasi"
}

# Layout switcher
selected=$(show_rofi_menu)

if [[ -n "$selected" && -n "${LAYOUTS[$selected]}" ]]; then
  target_layout="${LAYOUTS[$selected]}"

  for i in "${!layout_list[@]}"; do
    if [[ "${layout_list[$i]}" == "$target_layout" ]]; then
      hyprctl switchxkblayout "$keyboard_name" "$i"
      exit 0
    fi
  done

  echo "Warning: Layout '$target_layout' not found in available layouts" >&2
  exit 1
fi
