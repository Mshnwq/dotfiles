#!/usr/bin/env bash
set -uo pipefail

# Extract details
IFS=$'\t' read -r layouts_csv keyboard_name active_keymap active_index < \
  <(hyprctl devices -j | jq -r \
    '.keyboards[] | select(.main == true) | [.layout, .name, .active_keymap, .active_layout_index] | @tsv')
IFS=',' read -ra layout_list <<<"$layouts_csv"

# Load layout mappings from config file
LAYOUT_CONFIG="$HOME/.config/keyboard_layouts.conf"
[[ -f $LAYOUT_CONFIG ]] || {
  echo "Creating example config file..."
  echo "US English=us" >"$LAYOUT_CONFIG"
}

declare -A layout
while IFS='=' read -r label code; do
  [[ -z $label || $label =~ ^[[:space:]]*# ]] && continue
  label=$(echo "$label" | xargs)
  code=$(echo "$code" | xargs)
  [[ -n $label && -n $code ]] && layout["$label"]="$code"
done <"$LAYOUT_CONFIG"

# Check if any layouts were loaded
((${#layout[@]} == 0)) && {
  echo "Error: No layouts defined in $LAYOUT_CONFIG"
  exit 1
}

selected_index=0
for lang in "${layout[@]}"; do
  [[ "${layout_list[$active_index]}" == "$lang" ]] && break
  ((selected_index++))
done

rofi_menu() {
  printf '%s\n' "${!layout[@]}" | rofi \
    -dmenu \
    -markup-rows \
    -p "Keyboard Layout" \
    -selected-row "$selected_index" \
    -mesg "Current Layout: $active_keymap" \
    -theme "$HOME/.config/rofi/SelectorKeyboard.rasi"
}

# Layout switcher
selected=$(rofi_menu)
[[ -n $selected && -n ${layout[$selected]} ]] || {
  echo "Warning: Layout '$selected' not found in available layouts"
  exit 1
}

for ((i = 0; i < ${#layout[@]}; i++)); do
  [[ "${layout_list[$i]}" == "${layout[$selected]}" ]] && {
    hyprctl switchxkblayout "$keyboard_name" "$i" &&
      sleep 0.1 && dunstify -r 91192 -i input-keyboard-symbolic "Set Languege" -u low \
      "$(hyprctl devices -j | jq -r '.keyboards[] | select(.main == true) | .active_keymap' | cut -d " " -f 1)" &&
      exit 0 || exit 1
  }
done
