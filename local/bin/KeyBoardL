#!/usr/bin/env bash

set -euo pipefail

# Get main keyboard info in one pass
keyboard=$(hyprctl devices -j | jq -c '.keyboards[] | select(.main == true)')

# Exit if no main keyboard found
[[ -n $keyboard ]] || {
  echo "Error: No main keyboard found" >&2
  exit 1
}

# Extract details using jq once
read -r keyboard_name active_keymap caps_state num_state < <(
  echo "$keyboard" | jq -r '[.name, .active_keymap, .capsLock, .numLock] | @tsv'
)

read -r layouts_csv < <(echo "$keyboard" | jq -r '[.layout] | @tsv')
IFS=',' read -ra layout_list <<<"$layouts_csv"

LAYOUT_CONFIG="$HOME/.config/keyboard_layouts.conf"
[[ -f "$LAYOUT_CONFIG" ]] || {
  echo "Creating example config file..."
  echo "US English=us" >"$LAYOUT_CONFIG"
}

# Load layout mappings from config file
declare -A LAYOUTS
while IFS='=' read -r label code; do
  [[ -z $label || $label =~ ^[[:space:]]*# ]] && continue
  label=$(echo "$label" | xargs)
  code=$(echo "$code" | xargs)
  [[ -n $label && -n $code ]] && LAYOUTS["$label"]="$code"
done <"$LAYOUT_CONFIG"

# Check if any layouts were loaded
((${#LAYOUTS[@]} != 0)) || {
  echo "Error: No layouts defined in $LAYOUT_CONFIG"
  exit 1
}

# Show layout chooser with rofi
show_rofi_menu() {
  local message="Current Layout: $active_keymap"$'\n\n'
  message+="Caps Lock: $caps_state"$'\n'
  message+="Num Lock: $num_state"
  printf '%s\n' "${!LAYOUTS[@]}" | rofi \
    -dmenu \
    -markup-rows \
    -mesg "$message" \
    -p "Keyboard Layout" \
    -theme "${HOME}/.config/rofi/SelectorKeyboard.rasi"
}

# Layout switcher
selected=$(show_rofi_menu)
[[ -n $selected && -n ${LAYOUTS[$selected]} ]] || {
  echo "Warning: Layout '$selected' not found in available layouts"
  exit 1
}

for ((i = 0; i < ${#LAYOUTS[@]}; i++)); do
  [[ "${layout_list[$i]}" == "${LAYOUTS[$selected]}" ]] && {
    hyprctl switchxkblayout "$keyboard_name" "$i"
    exit 0
  }
done
