#!/usr/bin/env bash
set -euo pipefail

CLIP_THEME="$HOME/.config/rofi/Clipboard.rasi"
export PATH="$HOME/.local/bin/executer:$HOME/.local/bin:$PATH"

# wrappers
_alacritty() { alacritty --class FloaTerm,"$1" --title="$1" "${@:2}"; }
_kitty() {
  local args=() && declare -A opts
  opts[--term]="--class FloaTerm --name %s --title %s"
  opts[--style]="-c $HOME/.config/kitty/kitty-%s.conf"
  while (($# > 0)); do
    [[ $1 =~ ^($(printf '%s|' "${!opts[@]}"))$ ]] || break
    # shellcheck disable=SC2206 # word split treat str as list
    args+=(${opts[$1]//%s/$2}) && shift 2
  done && args+=("$@") && kitty "${args[@]}"
}

_yazi_tmux() {
  _kitty --term FileTerm --style \
    hide -o window_padding_width="4" \
    -e tmux new -s yazi InitYazi "${@:1}"
}

case ${1:-} in
--menu) rofi -show drun -theme "$HOME/.config/rofi/Launcher.rasi" ;;
--execute) Executer ;;
--terminal) _kitty --style show ;;
--terminal-float) _alacritty FloaTerm ;;
--terminal-init)
  set +e
  tmux kill-server 2>/dev/null
  socket="unix:$XDG_RUNTIME_DIR/init-term-kitty.sock"
  _kitty --style hide --watcher tab_focus.py \
    --class=InitTerm --listen-on "$socket" -e tmux new -s init &
  sleep 0.3 && kitty @ --to "$socket" "set-tab-title" "Tmux"
  ;;
--top) _alacritty TopTerm -e btop -p 1 ;;
--disk) _alacritty DiskTerm -e disk --hold ;;
--fetch) _alacritty FetchTerm -o font.size=10 -e zsh -c 'fastfetch; read' ;;
--k9s)
  _alacritty K9Term -o font.size="10" -e sh -c \
    "TERM=xterm-256color KUBECACHEDIR=$HOME/.cache/kube k9s"
  ;;
--lazydocker)
  _alacritty K9Term -o font.size="10" -e sh -c \
    "DOCKER_HOST=unix://$XDG_RUNTIME_DIR/podman/podman.sock lazydocker"
  ;;
--netmanager) networkmanager_dmenu ;;
--bluetooth) rofi-bluetooth ;;
--buku) RofiBuku ;;
--clipboard)
  cliphist list | rofi -theme "$CLIP_THEME" -dmenu | cliphist decode | wl-copy
  ;;
--screenshot) shift && [[ $# -eq 0 || $# -eq 2 ]] && ScreenShot "$@" ;;
--powermenu) PowerMenu ;;
--android) AndroidMount ;;
--keyboard) KeyBoardL ;;
--wall) WallSelect ;;
--nvim) _kitty -e nvim -c Nvdash ;;
--mail) _kitty --term FileTerm -e neomutt ;;
--news) _kitty --term FileTerm -e newsboat ;;
--serie) _kitty --term FetchTerm --style hide -d "$(pwd)" -e "serie" ;;
--hm)
  shift && _kitty --term FileTerm --style hide -o font_size=8 \
    -d "$(<"$HOME/.config/dotdir")/setup" -e zsh -c "./hm.sh $*; read"
  ;;
--yazi) _kitty --style hide -e sh -c "zsh -ic yazi" ;;
--yazi-tmux) _yazi_tmux ;;
--yazi-tmux-last) _yazi_tmux --last ;;
--yazi-tmux-project) _yazi_tmux --project "${2:-tmux}" ;;
--music)
  _alacritty CavaTerm -o window.opacity="0.01" -e cava &
  trap "pkill -f CavaTerm" EXIT
  # shellcheck disable=SC2016
  _kitty --term MusicTerm --style hide -o font_size=10 -e \
    bash -c '[[ -s "$HOME/.config/dots/.mpd_status" ]] \
    && rmpc --address "$(<"$HOME/.config/dots/.mpd_host"):6600" \
    || dunstify "Music is not running."'
  ;;
# Web
--firefox) Firefox -P "$USER" "${2:-about:newtab}" ;;
--github)
  DOTDIR="$(sed "s|^~|$HOME|" "$HOME/.config/dotdir")"
  hyprctl dispatch workspace 1 && $0 --firefox \
    "$(grep 'github.com' "$DOTDIR/.git/config" |
      sed -E 's|.*(github\.com)[:/]([^/]+).*|\1/\2|')"
  ;;
# Apps
--files) dolphin ;;
--soundcontrol) pavucontrol ;;
--soundmixer) _alacritty SoundTerm -e pulsemixer ;;
--completion-list) grep -oP -- '--[a-z-]+(?=\))' "$0" ;;
--help) echo "Usage: ${0##*/} <option>" ;;
"") $0 --help >&2 && exit 1 ;;
*) echo "Error: Invalid option $1" >&2 && $0 ;;
esac
