#!/usr/bin/env bash
set -euo pipefail

CLIP_THEME="$HOME/.config/rofi/Clipboard.rasi"
export PATH="$HOME/.local/bin/executer:$HOME/.local/bin:$PATH"

# useful wrappers
_alacritty() {
  local term && term="$1" && shift
  alacritty --class FloaTerm,"$term" --title="$term" "$@"
}

_kitty() {
  local kitty_args && kitty_args=()
  while (($# > 0)); do
    case $1 in
    --style)
      [[ -n $2 ]] && {
        kitty_args+=(-c "$HOME/.config/kitty/kitty-$2.conf")
        shift
      }
      shift
      ;;
    --term)
      [[ -n $2 ]] && {
        kitty_args+=(--class FloaTerm --name "$2" --title "$2")
        shift
      }
      shift
      ;;
    *)
      break
      ;;
    esac
  done
  kitty_args+=("$@") && kitty "${kitty_args[@]}"
}

case ${1:-} in
--menu) rofi -show drun -theme "$HOME/.config/rofi/Launcher.rasi" ;;
--execute) Executer ;;
--terminal) _kitty --style show ;;
--terminal-float) _alacritty FloaTerm ;;
--terminal-init)
  set +e
  tmux kill-server 2>/dev/null
  socket="unix:$XDG_RUNTIME_DIR/init-term-kitty.sock"
  _kitty --style hide --watcher tab_focus.py \
    --class=InitTerm --listen-on "$socket" -e tmux new -s init &
  sleep 0.3 && kitty @ --to "$socket" "set-tab-title" "Tmux"
  ;;
--top) _alacritty TopTerm -e btop -p 1 ;;
--disk) _alacritty DiskTerm -e disk --hold ;;
--fetch) _alacritty FetchTerm -o font.size=10 -e zsh -c 'fastfetch; read' ;;
--k9s)
  _alacritty K9Term -o font.size="10" -e sh -c \
    "KUBE_EDITOR=$HOME/.local/bin/vim TERM=xterm-256color KUBECACHEDIR=$HOME/.cache/kube k9s"
  ;;
--lazydocker)
  _alacritty K9Term -o font.size="10" -e sh -c \
    "DOCKER_HOST=unix://$XDG_RUNTIME_DIR/podman/podman.sock lazydocker"
  ;;
--netmanager) NetManagerDM ;;
--bluetooth) RofiBluetooth ;;
--buku) RofiBuku ;;
--clipboard)
  cliphist list | rofi -theme "$CLIP_THEME" -dmenu | cliphist decode | wl-copy
  ;;
--screenshot-menu) ScreenShoTer ;;
--screenshot-now) ScreenShoTer --override now ;;
--screenshot-sel) ScreenShoTer --override sel ;;
--powermenu) PowerMenu ;;
--android) AndroidMount ;;
--keyboard) KeyBoardL ;;
--wall) WallSelect ;;
--nvim) _kitty -e nvim -c Nvdash ;;
--serie) _kitty --term FetchTerm --style hide -d "$(pwd)" -e "serie" ;;
--hm)
  shift && _kitty --term FileTerm --style hide -o font_size=8 \
    -d "$(<"$HOME/.config/dotdir")/setup" -e zsh -c "./hm.sh $*; read"
  ;;
--yazi)
  _kitty --style hide -e sh -c \
    'exec zsh -c "EDITOR=~/.local/bin/vim yazi ~"'
  ;;
--yazi-tmux)
  _kitty --term FileTerm --style hide -o window_padding_width="4" -e \
    tmux new -s yazi -c "$HOME" InitYazi
  ;;
--yazi-tmux-last)
  _kitty --term FileTerm --style hide -o window_padding_width="4" -e \
    tmux new -s yazi InitYazi --last
  ;;
--yazi-tmux-project)
  _kitty --term FileTerm --style hide -o window_padding_width="4" -e \
    tmux new -s yazi InitYazi --project coom
  ;;
--music)
  _alacritty CavaTerm -o window.opacity="0.01" -e cava &
  cava_pid=$!
  _kitty --term MusicTerm --style hide -o font_size=10 -e Music &
  music_pid=$!
  hyprctl dispatch focuswindow title:MusicTerm
  wait $music_pid
  kill $cava_pid
  ;;
  # Apps
--firefox) Firefox -P mshnwq ;;
--files) dolphin ;;
--soundcontrol) pavucontrol ;;
--soundmixer) _alacritty SoundTerm -e pulsemixer ;;
--completion-list) grep -oP -- '--[a-z-]+(?=\))' "$0" ;;
"") echo "Usage: ${0##*/} <option>" >&2 && exit 1 ;;
*) echo "Error: Invalid option $1" >&2 && exit 1 ;;
esac
